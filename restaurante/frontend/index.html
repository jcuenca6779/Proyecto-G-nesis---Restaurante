<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visualizaci√≥n de Mesas</title>
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </head>
  <body>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <div id="app">
      <div class="container">
        <div class="header">
          <h1>SISTEMA DE GESTI√ìN DE MESAS</h1>
          <p>"El patac√≥n de √ìscar" - Mapa Interactivo</p>
        </div>

        <div class="main-content">
          <div class="controls-panel">
            <div class="panel-header">
              <h2>Controles</h2>
              <button class="help-button" @click="toggleInstructions">
                <i class="fas fa-question-circle"></i>
              </button>
            </div>
            
            <div class="controls-grid">
              <div class="control-group">
                <h3>Estado de Mesa</h3>
                <div class="button-group">
                  <button
                    class="badge disponible"
                    @click="cambiarEstado(ESTADOS_MESA.DISPONIBLE)"
                    :disabled="mesasSeleccionadas.length !== 1"
                  >
                    <span>‚úÖ</span> Disponible
                  </button>
                  <button
                    class="badge ocupada"
                    @click="cambiarEstado(ESTADOS_MESA.OCUPADA)"
                    :disabled="mesasSeleccionadas.length !== 1"
                  >
                    <span>‚õî</span> Ocupada
                  </button>
                  <button
                    class="badge reservada"
                    @click="cambiarEstado(ESTADOS_MESA.RESERVADA)"
                    :disabled="deshabilitarReservada"
                  >
                    <span>üìÖ</span> Reservada
                  </button>
                </div>
              </div>
              
              <div class="control-group">
                <h3>Acciones de Grupo</h3>
                <div class="button-group">
                  <button
                    class="badge separar"
                    @click="separarGrupoSeleccionado"
                    :disabled="!grupoSeleccionado"
                  >
                    <span>‚úÇÔ∏è</span> Separar grupo
                  </button>
                </div>
              </div>
              
              <div class="control-group">
                <h3>Gesti√≥n de Mesas</h3>
                <div class="button-group">
                  <button 
                    class="badge add" 
                    @click="agregarMesaNueva" 
                  >
                    <span>‚ûï</span> A√±adir Mesa
                  </button>
                  <button 
                    class="badge delete" 
                    @click="eliminarMesaSeleccionada" 
                    :disabled="mesasSeleccionadas.length !== 1" 
                  >
                    <span>‚ûñ</span> Eliminar Mesa
                  </button>
                </div>
              </div>
            </div>
            
            <div class="info-section">
              <div
                v-if="mesasSeleccionadas.length === 1 && mesasIndividuales.find(m => m.id === mesasSeleccionadas[0]) && esMesaOcupada(mesasIndividuales.find(m => m.id === mesasSeleccionadas[0]))"
                class="status-info"
              >
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                  <strong>¬°Atenci√≥n!</strong>
                  <p>La mesa est√° ocupada y no puede ser marcada como reservada</p>
                </div>
              </div>
              
              <div v-if="mesasSeleccionadas.length > 0" class="selection-info">
                <i class="fas fa-check-circle"></i>
                <div>
                  <strong>Mesa seleccionada:</strong>
                  <p>{{ mesasSeleccionadas.join(', ') }}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="map-container">
            <!-- Modal de instrucciones -->
            <div v-if="showInstructions" class="modal" @click.self="showInstructions = false">
              <div class="modal-content">
                <button class="modal-close" @click="showInstructions = false">
                  <i class="fas fa-times"></i>
                </button>
                <h2>Instrucciones de Uso</h2>
                <div class="instructions">
                  <p>
                    <span class="highlight">Para cambiar estado:</span> Seleccione
                    UNA mesa y luego elija un estado
                  </p>
                  <p>
                    <span class="highlight">Para unir mesas:</span> Arrastre una
                    mesa sobre otra para unirlas
                  </p>
                  <p>
                    <span class="highlight">Para separar:</span> Haga clic en un
                    grupo y luego en el bot√≥n "Separar"
                  </p>
                  <p>
                    <span class="highlight">Para mover:</span> Arrastre una mesa o
                    grupo a la posici√≥n deseada
                  </p>
                </div>
              </div>
            </div>

            <div
              class="restaurant-map"
              @mousemove="handleDragMove"
              @mouseup="handleStopDrag"
              @mouseleave="handleStopDrag"
            >
              <div v-for="elemento in elementosDecorativos" :key="elemento.id"
                class="layout-elemento"
                :class="[elemento.tipo]"
                :style="{ 
                  left: elemento.x + 'px', top: elemento.y + 'px', 
                  width: elemento.width + 'px', height: elemento.height + 'px',
                  transform: 'rotate(' + (elemento.rotacion || 0) + 'deg)',
                  backgroundColor: elemento.color 
                }">
              </div>
              
              <div class="map-boundary"></div>

              <div
                v-if="draggingItem"
                class="drag-indicator"
                :style="{
                  left: dragPosition.x + 'px',
                  top: dragPosition.y + 'px',
                  width: dragIndicatorSize.width + 'px',
                  height: dragIndicatorSize.height + 'px'
                }"
              >
                {{ draggingItem.id }}
              </div>

              <div class="union-feedback" :class="{ show: showUnionFeedback }">
                ¬°Mesas unidas con √©xito!
              </div>

              <div
                v-for="grupo in grupos"
                :key="grupo.id"
                class="mesa-grupo"
                :class="{ 
                  'grupo-seleccionado': grupoSeleccionado === grupo.id,
                  'dragging': draggingItem && draggingItem.type === 'grupo' && draggingItem.id === grupo.id
                }"
                :style="{ left: grupo.x + 'px', top: grupo.y + 'px' }"
                @mousedown="handleStartDrag($event, grupo, 'grupo')"
                @click="seleccionarGrupo(grupo.id)"
              >
                <h3>Grupo {{ grupo.id }}</h3>
                <div class="grupo-info">
                  Capacidad: {{ grupo.capacidadTotal }}
                </div>
                <div class="grupo-info">Estado: {{ grupo.estado }}</div>
                <div class="grupo-info" style="font-size: 0.9rem">
                  Mesas: {{ grupo.mesas.map(m => m.id).join(', ') }}
                </div>
              </div>

              <div
                v-for="mesa in mesasIndividuales"
                :key="mesa.id"
                :class="['mesa', mesa.forma, {
                  'mesa-seleccionada': mesasSeleccionadas.includes(mesa.id),
                  'dragging': draggingItem && draggingItem.type === 'mesa' && draggingItem.id === mesa.id,
                  'drop-target': dropTarget === mesa.id
                }]"
                :style="{
                  backgroundColor: obtenerColor(mesa.estado),
                  left: mesa.x + 'px',
                  top: mesa.y + 'px'
                }"
                @mousedown="handleStartDrag($event, mesa, 'mesa')"
                @mousemove="handleDragMove"
                @mouseup="handleDropWrapper($event, mesa)"
                @click.exact="seleccionarMesaIndividual(mesa.id)"
              >
                <h3>Mesa {{ mesa.id }}</h3>
                <p>Cap: {{ mesa.capacidad }} personas</p>
                <p>Estado: {{ mesa.estado }}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="stats" style="position: relative">
          <div class="stat-item">
            <div>Mesas disponibles</div>
            <div class="stat-value">{{ estadisticas.disponibles }}</div>
          </div>
          <div class="stat-item">
            <div>Mesas ocupadas</div>
            <div class="stat-value">{{ estadisticas.ocupadas }}</div>
          </div>
          <div class="stat-item">
            <div>Mesas reservadas</div>
            <div class="stat-value">{{ estadisticas.reservadas }}</div>
          </div>
          <div class="stat-item">
            <div>Mesas unidas</div>
            <div class="stat-value">{{ estadisticas.grupos }}</div>
          </div>
          <div class="stat-item">
            <div>Capacidad total</div>
            <div class="stat-value">{{ estadisticas.capacidadTotal }}</div>
          </div>
        </div>
      </div>
    </div>
    <script type="module" src="./js/app.js"></script>
  </body>
</html>